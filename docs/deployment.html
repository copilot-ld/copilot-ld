<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Copilot-LD â€“ Deployment Guide</title>
    <link rel="icon" href="favicon.svg" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
    />
    <link rel="stylesheet" href="assets/main.css" />
  </head>
  <body>
    <header class="container">
      <hgroup>
        <h1>
          <a href="index.html">ðŸ§¬ <mark>Copilot-LD</mark></a>
        </h1>
        <p>An intelligent agent leveraging GitHub Copilot and Linked Data</p>
      </hgroup>
      <nav>
        <ul>
          <li><a href="concepts.html">Concepts</a></li>
          <li>
            <details class="dropdown">
              <summary>Architecture</summary>
              <ul>
                <li><a href="architecture.html">Overview</a></li>
                <li><a href="reference.html">Reference</a></li>
              </ul>
            </details>
          </li>
          <li>
            <details class="dropdown">
              <summary>Guides</summary>
              <ul>
                <li><a href="configuration.html">Configuration</a></li>
                <li><a href="processing.html">Processing</a></li>
                <li><a href="deployment.html" class="active">Deployment</a></li>
                <li><a href="development.html">Development</a></li>
              </ul>
            </details>
          </li>
        </ul>
      </nav>
    </header>
    <main class="container">
      <h2>Deployment Guide</h2>

      <p>
        This guide covers how to deploy and run Copilot-LD in production using
        either Docker Compose or AWS CloudFormation. Choose the deployment
        method that best fits your infrastructure requirements.
      </p>

      <aside>
        <nav>
          <h5>Contents</h5>
          <ul>
            <li><a href="#prerequisites">Prerequisites</a></li>
            <li><a href="#docker">Docker Compose Deployment</a></li>
            <li><a href="#aws">AWS CloudFormation Deployment</a></li>
            <li><a href="#production">Production Considerations</a></li>
            <li><a href="#troubleshooting">Troubleshooting</a></li>
            <li><a href="#maintenance">Maintenance</a></li>
          </ul>
        </nav>
        <hr />
      </aside>

      <h3 id="prerequisites">Prerequisites</h3>

      <ul>
        <li><a href="processing.html">Processing Guide</a> completed</li>
        <li>Docker and Docker Compose installed (for Docker deployment)</li>
        <li>AWS CLI configured (for CloudFormation deployment)</li>
      </ul>

      <p>
        <strong>Note:</strong> For GitHub Actions workflows, ensure S3 access
        credentials are configured as repository secrets.
      </p>

      <h3 id="docker">Docker Compose Deployment</h3>

      <p>
        The Docker Compose deployment provides a complete containerized stack
        with application load balancing, object storage, and all microservices.
      </p>

      <h4>Architecture Overview</h4>

      <p>The Docker Compose stack includes:</p>

      <ul>
        <li>
          <strong>Application Load Balancer (ALB)</strong>: nginx-based reverse
          proxy with SSL termination
        </li>
        <li>
          <strong>Object Storage</strong>: MinIO S3-compatible storage for data
          persistence
        </li>
        <li><strong>Extension Services</strong>: Web API interface</li>
        <li>
          <strong>Core Services</strong>: Agent, LLM, Memory, Vector, and Tool
          services
        </li>
        <li>
          <strong>Custom Tools</strong>: Example Hash service demonstrating tool
          extensibility
        </li>
      </ul>

      <h4>SSL Certificate Setup</h4>

      <p>
        Configure SSL certificates for secure HTTPS access. See the
        <a href="configuration.html#ssl-certificate-configuration"
          >SSL Certificate Configuration</a
        >
        section in the Configuration Guide for detailed setup instructions
        including self-signed certificate generation and production certificate
        installation.
      </p>

      <h4>Configuration</h4>

      <p>
        Configure environment variables and service settings. See the
        <a href="configuration.html">Configuration Guide</a> for complete
        details on all environment variables and YAML configuration options.
      </p>

      <h4>Deploy the Stack</h4>

      <p>
        The platform uses a unified Docker build process with a single
        <code>Dockerfile</code> that handles all components (services,
        extensions, and tools). Building the containers requires a GitHub
        Personal Access Token (PAT) with at minimum the
        <code>read:packages</code> scope. Put the token in
        <code>config/.build_token</code> and deploy the stack like this:
      </p>

      <pre><code># Build all container images using unified Dockerfile
GITHUB_TOKEN=$(cat config/.build_token) docker compose build

# Start the complete stack
docker compose up -d

# Check service status
docker compose ps</code></pre>

      <h4>Access Points</h4>

      <p>Once deployed, access the system via:</p>

      <ul>
        <li>
          <strong>Web Extension</strong>: <code>https://localhost/web</code>
        </li>
        <li>
          <strong>MinIO Console</strong>: <code>http://localhost:9001</code>
        </li>
      </ul>

      <h3 id="aws">AWS CloudFormation Deployment</h3>

      <p>
        Deploy Copilot-LD on AWS using ECS Fargate with CloudFormation for
        production-grade scalability and managed infrastructure.
      </p>

      <h4>AWS OIDC Setup for GitHub Actions</h4>

      <p>
        Before using the GitHub Actions workflows for automated deployment, you
        must configure AWS OpenID Connect (OIDC) to allow secure, keyless
        authentication from GitHub Actions to your AWS account.
      </p>

      <h5>1. Create GitHub OIDC Identity Provider in AWS</h5>

      <p>First, create an OIDC identity provider in your AWS account:</p>

      <pre><code># Using AWS CLI
aws iam create-open-id-connect-provider \
  --url https://token.actions.githubusercontent.com \
  --client-id-list sts.amazonaws.com \
  --thumbprint-list 6938fd4d98bab03faadb97b34396831e3780aea1 \
  --thumbprint-list 1c58a3a8518e8759bf075b76b750d4f2df264fcd</code></pre>

      <p>Or create via AWS Console:</p>
      <ul>
        <li>
          Navigate to <strong>IAM â†’ Identity providers â†’ Add provider</strong>
        </li>
        <li>Provider type: <strong>OpenID Connect</strong></li>
        <li>
          Provider URL: <code>https://token.actions.githubusercontent.com</code>
        </li>
        <li>Audience: <code>sts.amazonaws.com</code></li>
        <li>Add the thumbprints above (GitHub's current thumbprints)</li>
      </ul>

      <p>
        <strong>Reference:</strong>
        <a
          href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services"
          target="_blank"
          >GitHub Docs: Configuring OIDC in AWS</a
        >
      </p>

      <h5>2. Create IAM Role for GitHub Actions</h5>

      <p>
        Create an IAM role that GitHub Actions can assume. Save this as
        <code>github-actions-role.json</code>:
      </p>

      <pre><code>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Principal": {
                "Federated": "arn:aws:iam::YOUR_ACCOUNT_ID:oidc-provider/token.actions.githubusercontent.com"
            },
            "Condition": {
                "StringEquals": {
                    "token.actions.githubusercontent.com:aud": [
                        "sts.amazonaws.com"
                    ]
                },
                "StringLike": {
                    "token.actions.githubusercontent.com:sub": [
                        "repo:copilot-ld/copilot-ld:*"
                    ]
                }
            }
        }
    ]
}</code></pre>

      <p>Create the role and attach policies:</p>

      <pre><code># Create the role
aws iam create-role \
  --role-name GitHubActions-CopilotLD-Demo-Deploy \
  --assume-role-policy-document file://github-actions-role.json

# Attach CloudFormation permissions
aws iam attach-role-policy \
  --role-name GitHubActions-CopilotLD-Demo-Deploy \
  --policy-arn arn:aws:iam::aws:policy/CloudFormationFullAccess

# Attach EC2 permissions for network infrastructure deployment
aws iam attach-role-policy \
  --role-name GitHubActions-CopilotLD-Demo-Deploy \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2FullAccess

# Attach ECS permissions for service deployment
aws iam attach-role-policy \
  --role-name GitHubActions-CopilotLD-Demo-Deploy \
  --policy-arn arn:aws:iam::aws:policy/AmazonECS_FullAccess

# Attach IAM permissions for role creation
aws iam attach-role-policy \
  --role-name GitHubActions-CopilotLD-Demo-Deploy \
  --policy-arn arn:aws:iam::aws:policy/IAMFullAccess

# Attach S3 permissions for data management
aws iam attach-role-policy \
  --role-name GitHubActions-CopilotLD-Demo-Deploy \
  --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess

# Attach Secrets Manager permissions
aws iam attach-role-policy \
  --role-name GitHubActions-CopilotLD-Demo-Deploy \
  --policy-arn arn:aws:iam::aws:policy/SecretsManagerReadWrite

# Attach CloudWatch Logs permissions for log group management
aws iam attach-role-policy \
  --role-name GitHubActions-CopilotLD-Demo-Deploy \
  --policy-arn arn:aws:iam::aws:policy/CloudWatchLogsFullAccess</code></pre>

      <p>
        <strong>Security Note:</strong> For production environments, replace
        <code>*FullAccess</code> policies with more restrictive,
        principle-of-least-privilege policies tailored to your specific
        deployment needs.
      </p>

      <h5>3. Configure GitHub Repository Secrets</h5>

      <p>
        Add the following secrets to your GitHub repository (<strong
          >Settings â†’ Secrets and variables â†’ Actions</strong
        >):
      </p>

      <ul>
        <li>
          <strong>DEMO_AWS_DEPLOY_ROLE_ARN</strong>:
          <code
            >arn:aws:iam::YOUR_ACCOUNT_ID:role/GitHubActions-CopilotLD-Demo-Deploy</code
          >
        </li>
        <li>
          <strong>DEMO_GITHUB_TOKEN</strong>: Personal access token for GitHub
          API access (required for some workflows)
        </li>
      </ul>

      <h5>4. Workflow Usage</h5>

      <p>
        The configured OIDC role enables secure access in four deployment
        workflows:
      </p>

      <ul>
        <li>
          <strong>demo-network.yml</strong>: Deploys VPC network infrastructure
          including subnets, NAT gateway, and routing tables
        </li>
        <li>
          <strong>demo-secrets.yml</strong>: Deploys AWS Secrets Manager secrets
          for GitHub tokens and service authentication
        </li>
        <li>
          <strong>demo-data.yml</strong>: Generates demo data artifacts
          (configuration, knowledge base, tools) for deployment
        </li>
        <li>
          <strong>demo-storage.yml</strong>: Creates S3 storage infrastructure
          and IAM roles for data access
        </li>
        <li>
          <strong>demo-services.yml</strong>: Deploys the complete ECS service
          stack with load balancing
        </li>
      </ul>

      <p>
        For detailed CloudFormation deployment commands and parameters, refer to
        the actual workflow files in <code>.github/workflows/</code>. These
        workflows contain the most current deployment procedures and parameter
        configurations.
      </p>

      <p>
        <strong>Reference:</strong>
        <a
          href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html"
          target="_blank"
          >AWS Docs: Creating OIDC Identity Providers</a
        >
      </p>

      <h4>Automated Deployment</h4>

      <p>
        Use the GitHub Actions workflows for automated deployment. The workflows
        handle all CloudFormation stack creation, parameter management, and
        deployment orchestration. See the workflow files for specific
        implementation details and current deployment procedures.
      </p>

      <h4>Deployment Order</h4>

      <p>
        Deploy the CloudFormation stacks in the following order using the GitHub
        Actions workflows:
      </p>

      <ol>
        <li>
          <strong>Network Infrastructure</strong>: Deploy
          <code>demo-network.yml</code> workflow first to create the VPC,
          subnets, NAT gateways, and routing infrastructure
        </li>
        <li>
          <strong>Secrets Management</strong>: Deploy
          <code>demo-secrets.yml</code> workflow to create AWS Secrets Manager
          resources for secure credential storage
        </li>
        <li>
          <strong>Data Generation</strong>: Run
          <code>demo-data.yml</code> workflow to generate demo data artifacts
          including processed knowledge base, configuration, and tools
        </li>
        <li>
          <strong>Storage Infrastructure</strong>: Deploy
          <code>demo-storage.yml</code> workflow to create S3 bucket and IAM
          roles for data access
        </li>
        <li>
          <strong>Data Upload</strong>: Deploy
          <code>demo-upload.yml</code> workflow to upload generated demo data to
          the storage infrastructure
        </li>
        <li>
          <strong>Services</strong>: Deploy
          <code>demo-services.yml</code> workflow to create ECS services, load
          balancer, and application infrastructure
        </li>
      </ol>

      <p>
        Each stack outputs the necessary parameters for the next stack in the
        deployment chain. The network stack provides VPC and subnet IDs required
        by the services stack.
      </p>

      <h4>Data Upload</h4>

      <p>
        Upload your processed knowledge base to S3 for deployment. For complete
        data management instructions including upload configuration, download
        utilities, and storage management, see the
        <a href="processing.html#data-management-utilities"
          >Data Management Utilities</a
        >
        section in the Processing Guide.
      </p>

      <h3 id="production">Production Considerations</h3>

      <h4>Security</h4>

      <ul>
        <li>
          <strong>SSL Certificates</strong>: Use valid TLS certificates from a
          trusted CA
        </li>
        <li>
          <strong>GitHub Actions OIDC</strong>: Use OIDC authentication instead
          of long-lived AWS access keys for secure, keyless deployment from
          GitHub Actions
        </li>
        <li>
          <strong>Secret Management</strong>: Store GitHub tokens in AWS Secrets
          Manager or similar
        </li>
        <li>
          <strong>Network Security</strong>: Configure VPC security groups and
          NACLs appropriately
        </li>
        <li>
          <strong>Service Authentication</strong>: Rotate service secrets
          regularly
        </li>
        <li>
          <strong>IAM Role Policies</strong>: Use principle of least privilege
          for GitHub Actions deployment role and ECS service roles
        </li>
      </ul>

      <h3 id="troubleshooting">Troubleshooting</h3>

      <h4>Docker Compose Issues</h4>

      <ul>
        <li>
          <strong>Build Failures</strong>: Ensure Docker BuildKit is enabled
          (<code>DOCKER_BUILDKIT=1</code>)
        </li>
        <li>
          <strong>Port Conflicts</strong>: Check that ports 80, 443, 9000, and
          9001 are available
        </li>
        <li>
          <strong>Memory Issues</strong>: Increase Docker memory limits for
          resource-intensive services
        </li>
        <li>
          <strong>Network Problems</strong>: Verify internal service
          connectivity with <code>docker-compose logs</code>
        </li>
      </ul>

      <h4>AWS CloudFormation Issues</h4>

      <ul>
        <li>
          <strong>Stack Creation Failures</strong>: Check CloudFormation events
          for detailed error messages
        </li>
        <li>
          <strong>Service Health</strong>: Monitor ECS service health and task
          failures
        </li>
        <li>
          <strong>Load Balancer</strong>: Verify target group health checks are
          passing
        </li>
        <li>
          <strong>IAM Permissions</strong>: Ensure service roles have required
          permissions for S3 access
        </li>
      </ul>

      <h4>GitHub Actions OIDC Issues</h4>

      <ul>
        <li>
          <strong>AssumeRole Failures</strong>: Verify the OIDC identity
          provider exists and the role trust policy matches your repository
          exactly (<code>repo:copilot-ld/copilot-ld:*</code>)
        </li>
        <li>
          <strong>Token Validation Errors</strong>: Check that
          <code>id-token: write</code> permission is set in workflow and
          thumbprints in OIDC provider are current
        </li>
        <li>
          <strong>Policy Permissions</strong>: Ensure the assumed role has
          sufficient permissions for CloudFormation, ECS, S3, and IAM operations
        </li>
        <li>
          <strong>Region Mismatches</strong>: Verify all resources are being
          created in the same AWS region (default: <code>us-east-1</code>)
        </li>
        <li>
          <strong>Secret Configuration</strong>: Confirm
          <code>AWS_DEPLOY_ROLE_ARN</code> secret contains the correct IAM role
          ARN format
        </li>
      </ul>

      <p>Debug OIDC authentication issues:</p>

      <pre><code># Validate OIDC provider exists
aws iam get-open-id-connect-provider \
  --open-id-connect-provider-arn arn:aws:iam::YOUR_ACCOUNT_ID:oidc-provider/token.actions.githubusercontent.com

# Check role trust policy
aws iam get-role --role-name GitHubActions-CopilotLD-Deploy --query 'Role.AssumeRolePolicyDocument'

# Test role assumption locally (requires AWS STS GetCallerIdentity)
aws sts get-caller-identity</code></pre>

      <h4>Common Deployment Validation</h4>

      <p>Validate your deployment:</p>

      <pre><code># Docker Compose validation
docker-compose ps
curl -k https://localhost/web/health

# AWS ECS validation
aws ecs list-services --cluster copilot-ld
aws elbv2 describe-target-health --target-group-arn arn:aws:elasticloadbalancing:...</code></pre>

      <h3 id="maintenance">Maintenance</h3>

      <h4>Updates</h4>

      <ul>
        <li>
          <strong>Rolling Updates</strong>: Update container images and redeploy
          services
        </li>
        <li>
          <strong>Configuration Changes</strong>: Update environment variables
          and restart services
        </li>
        <li>
          <strong>Knowledge Base Updates</strong>: Re-process and re-upload
          vector indices periodically
        </li>
      </ul>

      <h4>Backup</h4>

      <ul>
        <li>
          <strong>Data Backup</strong>: Regular S3 backups or MinIO data volume
          snapshots
        </li>
        <li>
          <strong>Configuration Backup</strong>: Version control all
          configuration files
        </li>
        <li>
          <strong>Image Registry</strong>: Maintain tagged container images for
          rollback capability
        </li>
      </ul>
    </main>
    <footer class="container">
      <p>Â© D. Olsson</p>
    </footer>
  </body>
</html>
