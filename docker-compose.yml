services:
  # Application Load Balancer
  alb:
    image: nginx:alpine
    container_name: copilot-ld.alb
    env_file: ./config/.env
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/docker/alb/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/docker/alb/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infrastructure/docker/alb/proxy_params:/etc/nginx/proxy_params:ro
      - ./data/cert/localhost.crt:/etc/ssl/certs/localhost.crt:ro
      - ./data/cert/localhost.key:/etc/ssl/private/localhost.key:ro
    networks:
      - external
    depends_on:
      - web
      - copilot

  # S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: copilot-ld.minio
    env_file: ./config/.env
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - external
      - internal

  # Extensions
  web:
    build:
      context: .
      dockerfile: ./extensions/web/Dockerfile
    image: copilot-ld/web:latest
    container_name: copilot-ld.web
    env_file: ./config/.env
    environment:
      - SERVICE_AGENT_HOST=agent
      - SERVICE_AGENT_PORT=3000
    networks:
      - external
      - internal
    depends_on:
      - agent

  copilot:
    build:
      context: .
      dockerfile: ./extensions/copilot/Dockerfile
    image: copilot-ld/copilot:latest
    container_name: copilot-ld.copilot
    env_file: ./config/.env
    environment:
      - SERVICE_AGENT_HOST=agent
      - SERVICE_AGENT_PORT=3000
    networks:
      - external
      - internal
    depends_on:
      - agent

  # Services
  agent:
    build:
      context: .
      dockerfile: ./services/agent/Dockerfile
    image: copilot-ld/agent:latest
    container_name: copilot-ld.agent
    env_file: ./config/.env
    environment:
      - SERVICE_MEMORY_HOST=memory
      - SERVICE_MEMORY_PORT=3000
      - SERVICE_LLM_HOST=llm
      - SERVICE_LLM_PORT=3000
      - SERVICE_VECTOR_HOST=vector
      - SERVICE_VECTOR_PORT=3000
    networks:
      - internal
    depends_on:
      - memory
      - llm
      - vector

  llm:
    build:
      context: .
      dockerfile: ./services/llm/Dockerfile
    image: copilot-ld/llm:latest
    container_name: copilot-ld.llm
    env_file: ./config/.env
    networks:
      - internal

  vector:
    build:
      context: .
      dockerfile: ./services/vector/Dockerfile
    image: copilot-ld/vector:latest
    container_name: copilot-ld.vector
    env_file: ./config/.env
    networks:
      - internal
    volumes:
      - ./data/storage/vectors:/app/data/storage/vectors

  memory:
    build:
      context: .
      dockerfile: ./services/memory/Dockerfile
    image: copilot-ld/memory:latest
    container_name: copilot-ld.memory
    env_file: ./config/.env
    networks:
      - internal
    volumes:
      - ./data/storage/memories:/app/data/storage/memories
      - ./data/storage/resources:/app/data/storage/resources
      - ./data/storage/policies:/app/data/storage/policies

networks:
  external:
    driver: bridge
    name: copilot-ld.external
  internal:
    driver: bridge
    name: copilot-ld.internal

volumes:
  minio_data:
    driver: local
