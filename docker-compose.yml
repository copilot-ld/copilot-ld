#
# Networking and Volumes
# Note: This file requires Docker BuildKit. Set DOCKER_BUILDKIT=1 or COMPOSE_DOCKER_CLI_BUILD=1
#

networks:
  external:
    driver: bridge
    name: copilot-ld.external
  internal:
    driver: bridge
    name: copilot-ld.internal

volumes:
  minio_data:
    driver: local

secrets:
  github_token:
    environment: GITHUB_TOKEN

#
# Services
#

services:
  #
  # Infrastructure Services
  #

  alb:
    image: nginx:alpine
    container_name: copilot-ld.alb
    env_file: ./config/.env
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/docker/alb/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/docker/alb/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infrastructure/docker/alb/proxy_params:/etc/nginx/proxy_params:ro
      - ./data/cert/localhost.crt:/etc/ssl/certs/localhost.crt:ro
      - ./data/cert/localhost.key:/etc/ssl/private/localhost.key:ro
    networks:
      - external
    depends_on:
      - web
      - copilot

  minio:
    image: minio/minio:latest
    container_name: copilot-ld.minio
    env_file: ./config/.env
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - external # Needs to be available to the host for administrative tasks
      - internal

  #
  # Extension Services
  #

  web:
    build:
      context: .
      dockerfile: ./extensions/web/Dockerfile
      secrets:
        - github_token
    image: copilot-ld/web:latest
    container_name: copilot-ld.web
    env_file: ./config/.env
    volumes:
      - ./generated:/app/generated:ro
    networks:
      - external
      - internal
    depends_on:
      - agent

  copilot:
    build:
      context: .
      dockerfile: ./extensions/copilot/Dockerfile
      secrets:
        - github_token
    image: copilot-ld/copilot:latest
    container_name: copilot-ld.copilot
    env_file: ./config/.env
    volumes:
      - ./generated:/app/generated:ro
    networks:
      - external
      - internal
    depends_on:
      - agent

  #
  # Core Services
  #

  agent:
    build:
      context: .
      dockerfile: ./services/agent/Dockerfile
      secrets:
        - github_token
    image: copilot-ld/agent:latest
    container_name: copilot-ld.agent
    env_file: ./config/.env
    volumes:
      - ./generated:/app/generated:ro
      - ./data/storage/policies:/app/data/storage/policies
      - ./data/storage/resources:/app/data/storage/resources
    networks:
      - internal
    depends_on:
      - memory
      - llm
      - vector
      - tool

  llm:
    build:
      context: .
      dockerfile: ./services/llm/Dockerfile
      secrets:
        - github_token
    image: copilot-ld/llm:latest
    container_name: copilot-ld.llm
    env_file: ./config/.env
    volumes:
      - ./generated:/app/generated:ro
    networks:
      - internal

  vector:
    build:
      context: .
      dockerfile: ./services/vector/Dockerfile
      secrets:
        - github_token
    image: copilot-ld/vector:latest
    container_name: copilot-ld.vector
    env_file: ./config/.env
    networks:
      - internal
    volumes:
      - ./generated:/app/generated:ro
      - ./data/storage/vectors:/app/data/storage/vectors

  memory:
    build:
      context: .
      dockerfile: ./services/memory/Dockerfile
      secrets:
        - github_token
    image: copilot-ld/memory:latest
    container_name: copilot-ld.memory
    env_file: ./config/.env
    networks:
      - internal
    volumes:
      - ./generated:/app/generated:ro
      - ./data/storage/memories:/app/data/storage/memories
      - ./data/storage/policies:/app/data/storage/policies
      - ./data/storage/resources:/app/data/storage/resources

  tool:
    build:
      context: .
      dockerfile: ./services/tool/Dockerfile
      secrets:
        - github_token
    image: copilot-ld/tool:latest
    container_name: copilot-ld.tool
    env_file: ./config/.env
    volumes:
      - ./generated:/app/generated:ro
    networks:
      - internal

  #
  # Example Tool Services
  #

  hash:
    build:
      context: .
      dockerfile: ./tools/hash/Dockerfile
      secrets:
        - github_token
    image: copilot-ld/hash:latest
    container_name: copilot-ld.hash
    env_file: ./config/.env
    volumes:
      - ./generated:/app/generated:ro
    networks:
      - internal
