#
# Volumes
# Note: This file requires Docker BuildKit. Set DOCKER_BUILDKIT=1 or COMPOSE_DOCKER_CLI_BUILD=1
#

volumes:
  minio_data:
    driver: local

secrets:
  github_token:
    environment: GITHUB_TOKEN

#
# Networks
#

networks:
  internal:
    driver: bridge

#
# Services
#

services:
  #
  # Infrastructure Services
  #

  alb:
    image: nginx:alpine
    container_name: alb.copilot-ld
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/docker/alb/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/docker/alb/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infrastructure/docker/alb/proxy_params:/etc/nginx/proxy_params:ro
      - ./data/cert/localhost.crt:/etc/ssl/certs/localhost.crt:ro
      - ./data/cert/localhost.key:/etc/ssl/private/localhost.key:ro
    networks:
      internal:
        aliases:
          - alb.copilot-ld.local
    depends_on:
      - web

  storage:
    image: minio/minio:latest
    container_name: storage.copilot-ld
    env_file: .env
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      internal:
        aliases:
          - storage.copilot-ld.local
    command: server /data --console-address ":9001"

  #
  # Extension Services
  #

  web:
    build:
      context: ./extensions/web
      dockerfile: ../../Dockerfile
      secrets:
        - github_token
    image: copilot-ld/web:latest
    container_name: web.copilot-ld
    env_file: .env
    networks:
      internal:
        aliases:
          - web.copilot-ld.local
    depends_on:
      - agent
      - storage

  #
  # Core Services
  #

  agent:
    build:
      context: ./services/agent
      dockerfile: ../../Dockerfile
      secrets:
        - github_token
    image: copilot-ld/agent:latest
    container_name: agent.copilot-ld
    env_file: .env
    volumes:
      - ./data/policies:/app/data/policies
      - ./data/resources:/app/data/resources
    networks:
      internal:
        aliases:
          - agent.copilot-ld.local
    depends_on:
      - memory
      - llm
      - vector
      - graph
      - tool
      - storage

  memory:
    build:
      context: ./services/memory
      dockerfile: ../../Dockerfile
      secrets:
        - github_token
    image: copilot-ld/memory:latest
    container_name: memory.copilot-ld
    env_file: .env
    volumes:
      - ./data/policies:/app/data/policies
      - ./data/resources:/app/data/resources
    networks:
      internal:
        aliases:
          - memory.copilot-ld.local
    depends_on:
      - storage

  llm:
    build:
      context: ./services/llm
      dockerfile: ../../Dockerfile
      secrets:
        - github_token
    image: copilot-ld/llm:latest
    container_name: llm.copilot-ld
    env_file: .env
    networks:
      internal:
        aliases:
          - llm.copilot-ld.local
    depends_on:
      - storage

  vector:
    build:
      context: ./services/vector
      dockerfile: ../../Dockerfile
      secrets:
        - github_token
    image: copilot-ld/vector:latest
    container_name: vector.copilot-ld
    env_file: .env
    networks:
      internal:
        aliases:
          - vector.copilot-ld.local
    depends_on:
      - storage

  graph:
    build:
      context: ./services/graph
      dockerfile: ../../Dockerfile
      secrets:
        - github_token
    image: copilot-ld/graph:latest
    container_name: graph.copilot-ld
    env_file: .env
    networks:
      internal:
        aliases:
          - graph.copilot-ld.local
    depends_on:
      - storage

  tool:
    build:
      context: ./services/tool
      dockerfile: ../../Dockerfile
      secrets:
        - github_token
    image: copilot-ld/tool:latest
    container_name: tool.copilot-ld
    env_file: .env
    networks:
      internal:
        aliases:
          - tool.copilot-ld.local
    depends_on:
      - storage

  #
  # Example Tool Services
  #

  hash:
    build:
      context: ./tools/hash
      dockerfile: ../../Dockerfile
      secrets:
        - github_token
    image: copilot-ld/hash:latest
    container_name: hash.copilot-ld
    env_file: .env
    networks:
      internal:
        aliases:
          - hash.copilot-ld.local
    depends_on:
      - storage
